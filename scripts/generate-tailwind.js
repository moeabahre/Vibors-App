/**
 * Generate tailwind.config.js from built token JSON
 * Run: node scripts/generate-tailwind.js
 */

const fs = require('fs');
const path = require('path');

const tokensPath = path.join(__dirname, '../build/web/tokens.json');
const outputPath = path.join(__dirname, '../build/web/tailwind.config.js');

if (!fs.existsSync(tokensPath)) {
  console.error('❌  tokens.json not found. Run npm run build:web first.');
  process.exit(1);
}

const tokens = JSON.parse(fs.readFileSync(tokensPath, 'utf-8'));

// ── Helper: flatten nested object to dot-notation paths
function flatten(obj, prefix = '') {
  return Object.entries(obj).reduce((acc, [key, val]) => {
    const fullKey = prefix ? `${prefix}-${key}` : key;
    if (typeof val === 'object' && val !== null && !('value' in val)) {
      Object.assign(acc, flatten(val, fullKey));
    } else {
      acc[fullKey] = val?.value ?? val;
    }
    return acc;
  }, {});
}

// ── Extract sections
const flat = flatten(tokens);

const colors = {};
const spacing = {};
const fontSize = {};
const fontWeight = {};
const lineHeight = {};
const fontFamily = {};
const borderRadius = {};
const opacity = {};
const transitionDuration = {};
const transitionTimingFunction = {};

Object.entries(flat).forEach(([key, value]) => {
  if (key.startsWith('color-') || key.startsWith('background-') ||
      key.startsWith('text-') || key.startsWith('border-') ||
      key.startsWith('brand-') || key.startsWith('neutral-')) {
    // Convert kebab path to nested Tailwind color key
    const colorKey = key.replace(/^(color-)?/, '');
    colors[colorKey] = value;
  } else if (key.startsWith('space-') || key.startsWith('spacing-') ||
             key.includes('padding') || key.includes('margin') || key.includes('gap')) {
    spacing[key] = value;
  } else if (key.includes('font-size') || key.match(/\/(size|2xl|xl|lg|md|sm|xs)$/)) {
    fontSize[key] = value;
  } else if (key.includes('font-weight')) {
    fontWeight[key.replace('font-weight-', '')] = value;
  } else if (key.includes('line-height')) {
    lineHeight[key] = value;
  } else if (key.includes('font-family')) {
    fontFamily[key.replace('font-family-', '')] = value;
  } else if (key.includes('radius')) {
    borderRadius[key.replace('radius-', '')] = value;
  } else if (key.includes('opacity')) {
    opacity[key.replace('opacity-', '')] = value;
  } else if (key.includes('duration')) {
    transitionDuration[key.replace('duration-', '')] = value;
  } else if (key.includes('easing')) {
    transitionTimingFunction[key.replace('easing-', '')] = value;
  }
});

// ── Generate Tailwind config
const config = `/**
 * Vibors Design Tokens — Tailwind CSS Config
 * Auto-generated by scripts/generate-tailwind.js
 * DO NOT EDIT MANUALLY — edit tokens in Figma instead
 *
 * Generated: ${new Date().toISOString()}
 */

/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [],
  theme: {
    extend: {
      colors: ${JSON.stringify(colors, null, 6)},

      spacing: ${JSON.stringify(spacing, null, 6)},

      fontSize: ${JSON.stringify(fontSize, null, 6)},

      fontWeight: ${JSON.stringify(fontWeight, null, 6)},

      lineHeight: ${JSON.stringify(lineHeight, null, 6)},

      fontFamily: ${JSON.stringify(fontFamily, null, 6)},

      borderRadius: ${JSON.stringify(borderRadius, null, 6)},

      opacity: ${JSON.stringify(opacity, null, 6)},

      transitionDuration: ${JSON.stringify(transitionDuration, null, 6)},

      transitionTimingFunction: ${JSON.stringify(transitionTimingFunction, null, 6)},
    },
  },
  plugins: [],
};
`;

fs.writeFileSync(outputPath, config, 'utf-8');
console.log(`✅  Tailwind config generated → ${outputPath}`);
console.log(`    Colors: ${Object.keys(colors).length} tokens`);
console.log(`    Spacing: ${Object.keys(spacing).length} tokens`);
console.log(`    Typography: ${Object.keys(fontSize).length} font sizes`);
